#!/bin/sh

this_dir=$(dirname "$0")

cd "${this_dir}" || exit 1
this_dir=$(pwd)

libucl=no
libargon2=no
pkg_path=

for arg in "$@"
do
  case "${arg}" in
    (libucl)
      pkg-config libucl || libucl=yes
      ;;
    (libargon2)
      pkg-config libargon2 || libargon2=yes
      ;;
    (*)
      ;;
  esac
done

pc_file()
{
  local pkg dir
  pkg="$1"; shift
  dir="$1"; shift

  echo "pcfile: ${pkg}" 1>&2

  if [ -z "${pkg_path}" ]
  then
    pkg_path="${dir}/pkgconf"
    mkdir -p "${pkg_path}"
  fi
  cat > "${pkg_path}/${pkg}.pc" <<EOF
Name: ${pkg}
Description: Development libraries for ${pkg}
Libs: -L${dir}/${pkg} ${pkg}.a
Cflags: -I${dir}/${pkg}/include
EOF
}

echo "cmd:" "$0" "$@" 1>&2

[ X"${libucl}" = X"yes" ] && pc_file libucl "${this_dir}"
[ X"${libargon2}" = X"yes" ] && pc_file libargon2 "${this_dir}"
if [ -n "${pkg_path}" ]
then
  export PKG_CONFIG_PATH="${pkg_path}"
  ls -l "${pkg_path}" 1>&2
fi
echo PKG_CONFIG_PATH="'${PKG_CONFIG_PATH}'" 1>&2

# determine read pkg-config
OLD_IFS="${IFS}"
IFS=':'
for dir in ${PATH}
do
  [ X"${dir}" = X"${this_dir}" ] && continue
  [ -d "${dir}" ] || continue
  pkg_config="${dir}/pkg-config"
  [ -x "${pkg_config}" ] && exec "${pkg_config}" "$@"
done
IFS="${OLD_IFS}"
echo 'could determine path to pkg-config' 1>&2
echo 'suggest: apt install pkgconf' 1>&2
exit 1
